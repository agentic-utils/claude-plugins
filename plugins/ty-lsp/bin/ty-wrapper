#!/bin/bash
set -euo pipefail

# ty-wrapper: Wrapper script for ty server that finds and uses project venv
#
# This script:
# 1. Finds nearest pyproject.toml walking up from CWD
# 2. Activates .venv if found in that project
# 3. Changes to project root so ty discovers configuration
# 4. Runs ty server

# Find nearest pyproject.toml walking up from CWD
find_project_root() {
    local dir="$PWD"
    while [[ "$dir" != "/" ]]; do
        if [[ -f "$dir/pyproject.toml" ]]; then
            echo "$dir"
            return 0
        fi
        dir="$(dirname "$dir")"
    done
    return 1
}

# Find project root, fallback to CWD
PROJECT_ROOT=$(find_project_root) || PROJECT_ROOT="$PWD"

# Activate venv if exists (check common patterns)
VENV_PATHS=(
    ".venv/bin/activate"
    "venv/bin/activate"
    ".virtualenv/bin/activate"
    "virtualenv/bin/activate"
    "env/bin/activate"
)

for venv_path in "${VENV_PATHS[@]}"; do
    if [[ -f "$PROJECT_ROOT/$venv_path" ]]; then
        # shellcheck source=/dev/null
        source "$PROJECT_ROOT/$venv_path"
        break
    fi
done

# Change to project root so ty discovers pyproject.toml and .venv
cd "$PROJECT_ROOT"

# Load direnv if .envrc exists and direnv is available
if [[ -f "$PROJECT_ROOT/.envrc" ]] && command -v direnv &>/dev/null; then
    eval "$(direnv export bash 2>/dev/null)" || true
fi

# Run ty server
exec ty server
